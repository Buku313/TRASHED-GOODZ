<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TRASHEDGOODS.STORE - Admin Panel</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="db-config.js?v=2"></script>
    <script src="db-api.js?v=2"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .login-box {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: #f0f0f0;
            border: 2px solid #3366CC;
        }
        .admin-header {
            background: #3366CC;
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
        }
        .product-form {
            background: #f9f9f9;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .image-upload {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }
        .image-upload:hover {
            border-color: #3366CC;
            background: #f0f0ff;
        }
        .image-upload.drag-over {
            border-color: #28a745;
            background: #e8f5e9;
            transform: scale(1.02);
        }
        .image-upload.uploading {
            border-color: #ffc107;
            background: #fff8e1;
        }
        .image-preview {
            display: inline-block;
            margin: 10px;
            position: relative;
            cursor: move;
        }
        .image-preview img {
            max-width: 150px;
            max-height: 150px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .image-preview:hover img {
            border-color: #3366CC;
        }
        .image-preview button {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .image-preview button:hover {
            background: #c82333;
        }
        .image-preview .primary-badge {
            position: absolute;
            top: -10px;
            left: -10px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .upload-progress {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #3366CC;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f0f0f0;
        }
        .btn-primary {
            background: #3366CC;
            color: white;
            border-color: #3366CC;
        }
        .btn-success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .product-list {
            margin: 20px 0;
        }
        .product-item {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .product-item img {
            max-width: 100px;
            max-height: 100px;
        }
        .product-info {
            flex: 1;
        }
        .product-actions button {
            margin: 2px;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-draft { background: #ffc107; color: #000; }
        .status-published { background: #28a745; color: white; }
        .status-sold { background: #6c757d; color: white; }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border: 1px solid;
            border-radius: 4px;
        }
        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        #setupSection { display: none; }
        #loginSection { display: none; }
        #adminSection { display: none; }
        .setup-box {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: #f0f0f0;
            border: 2px solid #3366CC;
        }
        .setup-step {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #3366CC;
        }
        .settings-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #666;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .settings-icon:hover {
            background: #3366CC;
        }
    </style>
</head>
<body>

<!-- Setup Section -->
<div id="setupSection">
    <table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
        <tr>
            <td>
                <table width="980" border="0" align="center" cellpadding="5" cellspacing="0">
                    <tr>
                        <td>
                            <font size="6" color="#CC0000"><b>TRASHEDGOODS.STORE</b></font>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div class="setup-box">
        <h2 style="margin-top: 0; color: #3366CC;">üöÄ Welcome! Let's Set Up Your Admin Panel</h2>
        <p>You'll need a free JSONBin API key to save your products. It only takes 2 minutes!</p>

        <div class="setup-step">
            <h3>Step 1: Get Your Free API Key</h3>
            <ol>
                <li>Go to <a href="https://jsonbin.io" target="_blank"><b>jsonbin.io</b></a> and sign up (free!)</li>
                <li>After login, click <b>"API Keys"</b> in the sidebar</li>
                <li>Click <b>"Create Access Key"</b></li>
                <li>Copy the API key (starts with <code>$2a$10$...</code>)</li>
            </ol>
        </div>

        <div class="setup-step">
            <h3>Step 2: Enter Your API Key</h3>
            <div class="form-group">
                <label>JSONBin API Key:</label>
                <input type="text" id="setupApiKey" placeholder="$2a$10$..." style="font-family: monospace;">
            </div>
            <div class="form-group">
                <label>Admin Password (optional - change default):</label>
                <input type="password" id="setupPassword" placeholder="Leave blank to use: trashedgoods2008">
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="saveSetup()" style="width: 100%; padding: 15px; font-size: 16px;">
                ‚úÖ Save & Continue
            </button>
        </div>

        <div id="setupError" style="color: red; margin-top: 15px; display: none;"></div>
        <div id="setupSuccess" style="color: green; margin-top: 15px; display: none;"></div>
    </div>
</div>

<!-- Login Section -->
<div id="loginSection">
    <table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
        <tr>
            <td>
                <table width="980" border="0" align="center" cellpadding="5" cellspacing="0">
                    <tr>
                        <td>
                            <font size="6" color="#CC0000"><b>TRASHEDGOODS.STORE</b></font>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div class="login-box">
        <h2 style="margin-top: 0; color: #3366CC;">Admin Login</h2>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
        </div>
        <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
        <div id="loginError" style="color: red; margin-top: 10px; display: none;"></div>
    </div>
</div>

<!-- Admin Section -->
<div id="adminSection">
    <a href="#" class="settings-icon" onclick="showSettings(); return false;">‚öôÔ∏è Settings</a>

    <table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
        <tr>
            <td>
                <table width="980" border="0" align="center" cellpadding="5" cellspacing="0">
                    <tr>
                        <td>
                            <font size="6" color="#CC0000"><b>TRASHEDGOODS.STORE</b></font>
                            <br><font size="2" color="#666"><b>Admin Panel</b></font>
                        </td>
                        <td align="right">
                            <a href="index.html">View Store</a> |
                            <a href="#" onclick="logout(); return false;">Logout</a>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div class="admin-container">
        <div id="message"></div>

        <!-- Add Product Form -->
        <div class="product-form">
            <h2 style="margin-top: 0;">Add New Product</h2>

            <div class="form-group">
                <label>Product Name *</label>
                <input type="text" id="productName" placeholder="e.g., Vintage Nike Shoes">
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" placeholder="Describe the product..."></textarea>
            </div>

            <div class="form-group">
                <label>Price ($) *</label>
                <input type="number" id="productPrice" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Category *</label>
                <select id="productCategory">
                    <option value="">Select category...</option>
                </select>
            </div>

            <div class="form-group">
                <label>Condition *</label>
                <select id="productCondition">
                    <option value="new">New</option>
                    <option value="used">Used</option>
                    <option value="refurbished">Refurbished</option>
                </select>
            </div>

            <div class="form-group">
                <label>Stock *</label>
                <input type="number" id="productStock" value="1" min="0">
            </div>

            <div class="form-group">
                <label>Images</label>
                <div class="image-upload" id="imageUploadZone" onclick="triggerImageSelect()">
                    <div id="uploadText">üì∑ Click or drag images here<br><small>JPG or PNG, max 10MB each</small></div>
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <div id="progressText"></div>
                    </div>
                    <div id="imagePreviews"></div>
                </div>
                <input type="file" id="imageInput" accept="image/*" multiple capture="environment" style="display: none;" onchange="handleImageSelect(event)">
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    <b>Tip:</b> First image will be the main product image. Drag to reorder.
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveProduct('published')">‚úÖ Save & Publish</button>
                <button class="btn btn-primary" onclick="saveProduct('draft')">üíæ Save as Draft</button>
                <button class="btn" onclick="clearForm()">Clear Form</button>
            </div>
        </div>

        <!-- Products List -->
        <div>
            <h2>Your Products</h2>
            <div id="productsList" class="product-list">
                <div class="loading">Loading products...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentData = null;
let selectedImages = [];
let editingProductId = null;

// Check setup and login on page load
window.onload = function() {
    // Check if API key is configured
    if (!isAPIKeyConfigured()) {
        showSetupScreen();
        return;
    }

    // Check if already logged in
    const loggedIn = sessionStorage.getItem('admin_logged_in');
    if (loggedIn === 'true') {
        showAdminPanel();
    } else {
        showLoginScreen();
    }
};

function showSetupScreen() {
    document.getElementById('setupSection').style.display = 'block';
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('adminSection').style.display = 'none';
}

function showLoginScreen() {
    document.getElementById('setupSection').style.display = 'none';
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('adminSection').style.display = 'none';
}

function saveSetup() {
    const apiKey = document.getElementById('setupApiKey').value.trim();
    const password = document.getElementById('setupPassword').value.trim();
    const errorEl = document.getElementById('setupError');
    const successEl = document.getElementById('setupSuccess');

    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    if (!apiKey) {
        errorEl.textContent = 'Please enter your JSONBin API key!';
        errorEl.style.display = 'block';
        return;
    }

    // Save API key to localStorage
    setAPIKey(apiKey);

    // Save custom password if provided
    if (password) {
        setAdminPassword(password);
    }

    successEl.textContent = '‚úÖ Configuration saved! Redirecting to login...';
    successEl.style.display = 'block';

    setTimeout(() => {
        showLoginScreen();
    }, 1500);
}

function showSettings() {
    const apiKey = getAPIKey() || '';
    const binId = getBinId() || 'Not created yet';
    const imgbbKey = localStorage.getItem('tgs_imgbb_api_key') || '';
    const cloudinaryName = localStorage.getItem('tgs_cloudinary_cloud_name') || '';
    const cloudinaryPreset = localStorage.getItem('tgs_cloudinary_upload_preset') || '';

    let settingsMsg = '=== SETTINGS ===\n\n';
    settingsMsg += '1. Update JSONBin API Key\n';
    settingsMsg += '2. Update imgbb API Key (image hosting option 1)\n';
    settingsMsg += '3. Update Cloudinary Config (image hosting option 2)\n';
    settingsMsg += '4. View Image Upload Status\n';
    settingsMsg += '5. Change Admin Password\n';
    settingsMsg += '6. View Bin ID\n';
    settingsMsg += '7. Cancel\n\n';

    const choice = prompt(settingsMsg + 'Enter option (1-7):');

    if (choice === '1') {
        const newApiKey = prompt('Enter new JSONBin API Key:', apiKey);
        if (newApiKey && newApiKey.trim()) {
            setAPIKey(newApiKey.trim());
            alert('‚úÖ JSONBin API key updated!');
        }
    } else if (choice === '2') {
        const msg = 'To get a free imgbb API key:\n\n1. Go to https://api.imgbb.com/\n2. Click "Get API Key"\n3. Sign up (free, no credit card)\n4. Copy your API key\n\nEnter your imgbb API key:';
        const newImgbbKey = prompt(msg, imgbbKey);
        if (newImgbbKey && newImgbbKey.trim()) {
            localStorage.setItem('tgs_imgbb_api_key', newImgbbKey.trim());
            alert('‚úÖ imgbb API key saved! You can now upload images.');
        }
    } else if (choice === '3') {
        const msg1 = 'To setup Cloudinary (alternative to imgbb):\n\n1. Go to https://cloudinary.com/users/register_free\n2. Sign up (free)\n3. Go to Dashboard\n4. Copy your Cloud Name\n\nEnter your Cloudinary Cloud Name:';
        const newCloudName = prompt(msg1, cloudinaryName);
        if (newCloudName && newCloudName.trim()) {
            localStorage.setItem('tgs_cloudinary_cloud_name', newCloudName.trim());

            const msg2 = 'Now create an Upload Preset:\n\n1. Go to Settings ‚Üí Upload\n2. Scroll to "Upload presets"\n3. Click "Add upload preset"\n4. Set Signing Mode to "Unsigned"\n5. Save and copy the preset name\n\nEnter your Upload Preset name:';
            const newPreset = prompt(msg2, cloudinaryPreset);
            if (newPreset && newPreset.trim()) {
                localStorage.setItem('tgs_cloudinary_upload_preset', newPreset.trim());
                alert('‚úÖ Cloudinary configured! You can now upload images.');
            }
        }
    } else if (choice === '4') {
        let status = '=== IMAGE UPLOAD STATUS ===\n\n';
        if (imgbbKey) {
            status += '‚úÖ imgbb: Configured (Primary)\n';
        } else {
            status += '‚ùå imgbb: Not configured\n';
        }
        if (cloudinaryName && cloudinaryPreset) {
            status += '‚úÖ Cloudinary: Configured (Fallback)\n';
        } else {
            status += '‚ùå Cloudinary: Not configured\n';
        }
        status += '\nüìù Base64 embedding: Always available (for images < 500KB)\n';
        status += '\nüí° Tip: Configure at least one hosting service for best experience!';
        alert(status);
    } else if (choice === '5') {
        const newPassword = prompt('Enter new admin password:');
        if (newPassword && newPassword.trim()) {
            setAdminPassword(newPassword.trim());
            alert('‚úÖ Password updated! Please re-login.');
            logout();
        }
    } else if (choice === '6') {
        alert('Your Bin ID:\n\n' + (binId || 'Not created yet - will be created on first save'));
    }
}

function login() {
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    const correctPassword = getAdminPassword();

    if (password === correctPassword) {
        sessionStorage.setItem('admin_logged_in', 'true');
        showAdminPanel();
    } else {
        errorEl.textContent = 'Incorrect password!';
        errorEl.style.display = 'block';
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('admin_logged_in');
        showLoginScreen();
    }
}

async function showAdminPanel() {
    document.getElementById('setupSection').style.display = 'none';
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('adminSection').style.display = 'block';
    await loadData();
}

async function loadData() {
    try {
        showMessage('Loading...', 'info');
        currentData = await window.db.loadProducts();

        // Populate categories
        const categorySelect = document.getElementById('productCategory');
        categorySelect.innerHTML = '<option value="">Select category...</option>';
        (currentData.categories || []).forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
        });

        displayProducts();
        clearMessage();
    } catch (error) {
        showMessage('Error loading data: ' + error.message, 'error');
    }
}

function displayProducts() {
    const container = document.getElementById('productsList');
    const products = currentData.products || [];

    if (products.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No products yet. Add your first product above!</div>';
        return;
    }

    let html = '';
    products.forEach(product => {
        const imageUrl = (product.images && product.images[0]) || 'https://via.placeholder.com/100';
        html += `
            <div class="product-item">
                <img src="${imageUrl}" alt="${product.name}">
                <div class="product-info">
                    <h3 style="margin: 0 0 5px 0;">${product.name}</h3>
                    <p style="margin: 0; color: #666;">$${parseFloat(product.price).toFixed(2)} - Stock: ${product.stock}</p>
                    <p style="margin: 5px 0 0 0;">
                        <span class="status-badge status-${product.status}">${product.status.toUpperCase()}</span>
                        ${product.condition ? `<small>${product.condition}</small>` : ''}
                    </p>
                </div>
                <div class="product-actions">
                    <button class="btn btn-primary" onclick="editProduct('${product.id}')">Edit</button>
                    ${product.status === 'draft' ? `<button class="btn btn-success" onclick="publishProduct('${product.id}')">Publish</button>` : ''}
                    ${product.status === 'published' ? `<button class="btn" onclick="markAsSold('${product.id}')">Mark Sold</button>` : ''}
                    <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Trigger file input
function triggerImageSelect() {
    document.getElementById('imageInput').click();
}

// Setup drag and drop
window.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('imageUploadZone');
    if (!uploadZone) return;

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
            uploadZone.classList.add('drag-over');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
            uploadZone.classList.remove('drag-over');
        }, false);
    });

    // Handle dropped files
    uploadZone.addEventListener('drop', handleDrop, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleImageFiles(files);
}

async function handleImageSelect(event) {
    const files = event.target.files;
    await handleImageFiles(files);
    event.target.value = ''; // Reset for re-upload
}

async function handleImageFiles(files) {
    if (files.length === 0) return;

    const uploadZone = document.getElementById('imageUploadZone');
    const uploadText = document.getElementById('uploadText');
    const progressContainer = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    // Show progress UI
    uploadZone.classList.add('uploading');
    uploadText.style.display = 'none';
    progressContainer.style.display = 'block';

    let successCount = 0;
    let failCount = 0;
    const totalFiles = files.length;

    for (let i = 0; i < totalFiles; i++) {
        const file = files[i];
        const progress = Math.round(((i + 1) / totalFiles) * 100);

        try {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                throw new Error(`${file.name} is not an image file`);
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                throw new Error(`${file.name} is too large (max 10MB)`);
            }

            // Update progress
            progressFill.style.width = progress + '%';
            progressFill.textContent = progress + '%';
            progressText.textContent = `Processing ${file.name}... (${i + 1}/${totalFiles})`;

            // Compress image
            const compressed = await window.db.compressImage(file, 1200, 0.85);

            // Upload with fallback system
            progressText.textContent = `Uploading ${file.name}... (${i + 1}/${totalFiles})`;
            const imageUrl = await window.db.uploadImage(compressed);

            selectedImages.push(imageUrl);
            successCount++;

            // Add to preview
            addImagePreview(imageUrl);

        } catch (error) {
            console.error(`Failed to upload ${file.name}:`, error);
            failCount++;

            // If it's a configuration error, show it prominently and stop
            if (error.message.includes('configure')) {
                uploadText.textContent = '‚ö†Ô∏è Image hosting not configured';
                uploadText.style.display = 'block';
                progressContainer.style.display = 'none';
                uploadZone.classList.remove('uploading');
                alert(error.message);
                return;
            }
        }
    }

    // Hide progress and show results
    uploadZone.classList.remove('uploading');
    progressContainer.style.display = 'none';
    uploadText.style.display = 'block';

    if (successCount > 0) {
        uploadText.innerHTML = `‚úÖ ${successCount} image(s) uploaded!<br><small>Click or drag to add more</small>`;
        showMessage(`Successfully uploaded ${successCount} image(s)!`, 'success');
    }

    if (failCount > 0) {
        showMessage(`${failCount} image(s) failed to upload. Check console for details.`, 'error');
    }

    updateImagePreviews();
}

function addImagePreview(url) {
    const previews = document.getElementById('imagePreviews');
    const index = selectedImages.length - 1;

    const previewDiv = document.createElement('div');
    previewDiv.className = 'image-preview';
    previewDiv.draggable = true;
    previewDiv.dataset.url = url;
    previewDiv.dataset.index = index;

    previewDiv.innerHTML = `
        ${index === 0 ? '<div class="primary-badge">‚òÖ</div>' : ''}
        <img src="${url}" alt="Preview ${index + 1}" loading="lazy">
        <button onclick="removeImage('${url}'); event.stopPropagation(); return false;" title="Remove image">√ó</button>
    `;

    // Add drag event listeners for reordering
    previewDiv.addEventListener('dragstart', handleDragStart);
    previewDiv.addEventListener('dragover', handleDragOver);
    previewDiv.addEventListener('drop', handleImageDrop);
    previewDiv.addEventListener('dragend', handleDragEnd);

    previews.appendChild(previewDiv);
}

// Drag and drop for reordering images
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleImageDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    if (draggedElement !== this) {
        // Get the URLs
        const draggedUrl = draggedElement.dataset.url;
        const targetUrl = this.dataset.url;

        // Find indices in array
        const draggedIndex = selectedImages.indexOf(draggedUrl);
        const targetIndex = selectedImages.indexOf(targetUrl);

        // Swap in array
        selectedImages.splice(draggedIndex, 1);
        selectedImages.splice(targetIndex, 0, draggedUrl);

        // Rebuild previews
        updateImagePreviews();
    }

    return false;
}

function handleDragEnd(e) {
    this.style.opacity = '1';
    draggedElement = null;
}

function removeImage(url) {
    selectedImages = selectedImages.filter(img => img !== url);
    updateImagePreviews();
}

function updateImagePreviews() {
    const previews = document.getElementById('imagePreviews');
    const uploadText = document.getElementById('uploadText');
    previews.innerHTML = '';

    selectedImages.forEach((url, index) => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        previewDiv.draggable = true;
        previewDiv.dataset.url = url;
        previewDiv.dataset.index = index;

        previewDiv.innerHTML = `
            ${index === 0 ? '<div class="primary-badge" title="Main product image">‚òÖ</div>' : ''}
            <img src="${url}" alt="Preview ${index + 1}" loading="lazy">
            <button onclick="removeImage('${url}'); event.stopPropagation(); return false;" title="Remove image">√ó</button>
        `;

        // Add drag event listeners for reordering
        previewDiv.addEventListener('dragstart', handleDragStart);
        previewDiv.addEventListener('dragover', handleDragOver);
        previewDiv.addEventListener('drop', handleImageDrop);
        previewDiv.addEventListener('dragend', handleDragEnd);

        previews.appendChild(previewDiv);
    });

    // Update upload text
    if (selectedImages.length > 0) {
        uploadText.innerHTML = `${selectedImages.length} image(s) uploaded<br><small>Click or drag to add more</small>`;
    } else {
        uploadText.innerHTML = 'üì∑ Click or drag images here<br><small>JPG or PNG, max 10MB each</small>';
    }
}

function displayImagePreviews() {
    updateImagePreviews();
}

async function saveProduct(status = 'draft') {
    const name = document.getElementById('productName').value.trim();
    const description = document.getElementById('productDescription').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value);
    const category = document.getElementById('productCategory').value;
    const condition = document.getElementById('productCondition').value;
    const stock = parseInt(document.getElementById('productStock').value);

    // Validation
    if (!name || !price || !category || stock < 0) {
        showMessage('Please fill in all required fields (*)!', 'error');
        return;
    }

    const product = {
        id: editingProductId || 'prod_' + Date.now(),
        name,
        description,
        price,
        category,
        condition,
        stock,
        images: selectedImages,
        status,
        createdAt: editingProductId ? currentData.products.find(p => p.id === editingProductId).createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };

    try {
        showMessage('Saving...', 'info');

        // Update or add product
        if (editingProductId) {
            const index = currentData.products.findIndex(p => p.id === editingProductId);
            currentData.products[index] = product;
        } else {
            if (!currentData.products) currentData.products = [];
            currentData.products.push(product);
        }

        // Save to database
        await window.db.saveProducts(currentData);

        showMessage('Product saved successfully!', 'success');
        clearForm();
        displayProducts();
    } catch (error) {
        showMessage('Error saving product: ' + error.message, 'error');
    }
}

function editProduct(id) {
    const product = currentData.products.find(p => p.id === id);
    if (!product) return;

    editingProductId = id;
    document.getElementById('productName').value = product.name;
    document.getElementById('productDescription').value = product.description || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productCategory').value = product.category;
    document.getElementById('productCondition').value = product.condition || 'used';
    document.getElementById('productStock').value = product.stock;

    selectedImages = product.images || [];
    updateImagePreviews();

    window.scrollTo({ top: 0, behavior: 'smooth' });
    showMessage('Editing product. Make changes and click Save.', 'info');
}

async function publishProduct(id) {
    const product = currentData.products.find(p => p.id === id);
    if (!product) return;

    product.status = 'published';
    product.updatedAt = new Date().toISOString();

    try {
        await window.db.saveProducts(currentData);
        showMessage('Product published!', 'success');
        displayProducts();
    } catch (error) {
        showMessage('Error publishing product: ' + error.message, 'error');
    }
}

async function markAsSold(id) {
    if (!confirm('Mark this product as sold?')) return;

    const product = currentData.products.find(p => p.id === id);
    if (!product) return;

    product.status = 'sold';
    product.updatedAt = new Date().toISOString();

    try {
        await window.db.saveProducts(currentData);
        showMessage('Product marked as sold!', 'success');
        displayProducts();
    } catch (error) {
        showMessage('Error updating product: ' + error.message, 'error');
    }
}

async function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product? This cannot be undone!')) return;

    currentData.products = currentData.products.filter(p => p.id !== id);

    try {
        await window.db.saveProducts(currentData);
        showMessage('Product deleted!', 'success');
        displayProducts();
    } catch (error) {
        showMessage('Error deleting product: ' + error.message, 'error');
    }
}

function clearForm() {
    editingProductId = null;
    document.getElementById('productName').value = '';
    document.getElementById('productDescription').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productCategory').value = '';
    document.getElementById('productCondition').value = 'used';
    document.getElementById('productStock').value = '1';
    selectedImages = [];
    updateImagePreviews();
    clearMessage();
}

function showMessage(text, type = 'info') {
    const messageEl = document.getElementById('message');
    messageEl.className = 'alert alert-' + type;
    messageEl.textContent = text;
    messageEl.style.display = 'block';
}

function clearMessage() {
    document.getElementById('message').style.display = 'none';
}
</script>

</body>
</html>
